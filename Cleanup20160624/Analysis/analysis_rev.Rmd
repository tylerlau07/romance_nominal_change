---
title: "Aggregate Data"
author: "Tyler Lau"
header-includes:
  - \DeclareUnicodeCharacter{0101}{\=a}
  - \DeclareUnicodeCharacter{0113}{\=e}
  - \DeclareUnicodeCharacter{012B}{\=\i}
  - \DeclareUnicodeCharacter{014D}{\=o}
  - \DeclareUnicodeCharacter{016B}{\=u}
date: "July 18, 2016"
output: pdf_document
---

```{r echo = FALSE, comment = NA}
library(stringr)
library(plyr)
library(data.table)

# Parameters: Token Frequency and Number of Cases
tokfreq <- "T"
ncases <- "5"
code <- 7

# Look only for most common suffix or for all suffixes below threshold?
onlymax <- TRUE

# IF APPLY SOUND CHANGE
soundchange <- TRUE
language <- 'Common'

# Number below which to drop
above <- 10

# Now set directory
directory <- c('../Main Code ', code, '/Cases', ncases, "/TokFreq", tokfreq)
if (code == 9) directory <- c(directory[1:4], c("/", language), directory[5:6])

setwd(paste0(directory, collapse = ""))
# setwd(paste0('../Main Code ', code, '/Cases', ncases, "/TokFreq", tokfreq))

print(paste0(language, ' Sound Change, Token Freq ', tokfreq))
print(paste0("Only considering max suffixes: ", onlymax))
if (onlymax == FALSE) print(paste0("Dropping suffixes that appear ", above, " or less times" ))

files = list.files(pattern = '\\.txt')

global_genders <- c('m', 'f', 'n')
global_decs <- 1:5
global_cases <- c('Nom', 'Acc', 'Gen', 'Dat', 'Abl')
global_casecombos <- c('Nom_Acc', 'Acc_Abl', 'Nom_Acc_Abl', 'Gen_Dat')
global_nums <- c('Sg', 'Pl')

#############
# Functions #
#############

# Remove rows with all 0's from frequency table
# Take in df with suffixes
# remove_zeros <- function(input_table) return(input_table[apply(input_table, 1, function(x) !all(x < 5)) ])

remove_zeros <- function(input_table, above) return(input_table[input_table > above])

applySoundChange <- function(vector, language) {
  # Dictionaries of changes
  diph_changes <- c('e', 'e', 'e', 'e', 'e', 'o')
  names(diph_changes) <- c('ai', 'ae', 'ei', 'ie', 'oe', 'au')
  
  sv_changes <- c('e', 'o', '')
  names(sv_changes) <- c('i', 'u', 'm')
  
  lv_changes <- c('a', 'e', 'i', 'o', 'u')
  names(lv_changes) <- c('ā', 'ē', 'ī', 'ō', 'ū')
  
  new_sufs <- vector
  if (language == 'Common') {
    for (diph in names(diph_changes)) new_sufs <- sub(diph, diph_changes[diph], new_sufs)
    for (sv in names(sv_changes)) {
      new_sufs <- sub(sv, sv_changes[sv], new_sufs)
    }
    for (lv in names(lv_changes)) new_sufs <- sub(lv, lv_changes[lv], new_sufs)
  }
  
  return(new_sufs)
}

# This function gets endings of a particular combination
# Take in relevant combo
freqTable <- function(df, genders = global_genders, decs = global_decs, cases = global_cases, nums = global_nums) {
  sub_df <- subset(df, Declension %in% decs & Gender %in% genders & Case %in% cases & Num %in% nums)
  return(aggregate(freq ~ Suffix, sub_df, sum))
}

# Takes freq table and returns endings, drops endings that have freq below
getEndings <- function(ft, above = 0) {
  return(paste(ft[ft$freq > above, ]$Suffix, collapse = ','))
}

# Return suffixes from freq table
maxSuf <- function(ft) {
  return(ft[which.max(ft$freq), ]$Suffix)
}

# Checks if vectors in list are all equal to one another
is.equal <- function(mylist) {
    check.eq <- sapply(mylist[-1], function(x) {x == mylist[[1]]})
    as.logical(apply(check.eq, 1, prod))                   
}

########
# MAIN #
########

# Initialize vectors to collect endings
for (num in global_nums) {
  # Number + Case
  for (combo in global_casecombos) {
    assign(paste(combo, num, 'systems', sep = '_'), c())
  }
  # Only by number
  assign(paste(num, 'systems', sep = "_"), c())
  # Number for Nom/Acc
  assign(paste('NomAcc', num, 'systems', sep = '_'), c())
  for (dec in global_decs) {
    # Number + Declension
    assign(paste(num, dec, 'systems', sep = "_"), c())
    for (combo in global_casecombos) {
      assign(paste(combo, num, dec, 'systems', sep = "_"), c())
    }
  }
  for (gender in global_genders) {
    # Number + Gender
    assign(paste(num, gender, 'systems', sep = "_"), c())
    for (combo in global_casecombos) {
      assign(paste(combo, num, gender, 'systems', sep = "_"), c())
    }
  }
}

################################
# Data Structure to Keep Track #
################################

full_tables <- list()
freq_tables <- list()
all_endings <- list()
# Endings that occur more than above times
endings <- list()
max_endings <- list()
systems <- list()
systems_df <- list()

########################
# Now go through files #
########################

for (i in 1:length(files)) {
  file = files[i]

  # Count human as same as nonhuman
  df <- read.delim(file, stringsAsFactors = FALSE)

  # Modify endings files
  colnames(df)[which(names(df) == "X10")] <- "Suffix"
  
  df[df == 'mh'] <- 'm'
  df[df == 'fh'] <- 'f'
  df[df == 'mh, fh'] <- 'm'
  df[df == 'm, f'] <- 'm'
  
  if (soundchange == TRUE) df$Suffix <- applySoundChange(df$Suffix, language)
  
  df[df == ''] <- '-'
  
  sub_df <- count(subset(df, select = c('Suffix', 'Declension', 'Gender', 'Num', 'Case')))
  
  full_tables[[as.character(i)]] <- sub_df
  
  # Initialize vector for system
  systems_df[[as.character(i)]] <- data.frame('Combo' = character(), 
                                           '1' = character(), 
                                           '2' = character(), 
                                           '3' = character(), 
                                           '4' = character(), 
                                           '5' = character())
  
  for (num in global_nums) {
    # Only Num
    ft <- freqTable(df = sub_df, num = num)
    freq_tables[[num]][[as.character(i)]] <- ft
    endings[[num]][[as.character(i)]] <- getEndings(ft, above = above)
    all_endings[[num]][[as.character(i)]] <- getEndings(ft, above = 0)
    max_endings[[num]][[as.character(i)]] <- maxSuf(ft)
    
    for (case in global_cases) {
      # Only Case
      ft <- freqTable(df = sub_df, case = case)
      freq_tables[[case]][[as.character(i)]] <- ft
      endings[[case]][[as.character(i)]] <- getEndings(ft, above = above)
      all_endings[[case]][[as.character(i)]] <- getEndings(ft, above = 0)
      max_endings[[case]][[as.character(i)]] <- maxSuf(ft)
      
      # Case & Num
      ft <- freqTable(df = sub_df, case = case, num = num)
      freq_tables[[paste0(case, num)]][[as.character(i)]] <- ft
      endings[[paste0(case, num)]][[as.character(i)]] <- getEndings(ft, above = above)
      all_endings[[paste0(case, num)]][[as.character(i)]] <- getEndings(ft, above = 0)
      max_endings[[paste0(case, num)]][[as.character(i)]] <- maxSuf(ft)

      for (dec in global_decs) {
        # Only Declension
        ft <- freqTable(df = sub_df, dec = dec)
        freq_tables[[as.character(dec)]][[as.character(i)]] <- ft
        endings[[as.character(dec)]][[as.character(i)]] <- getEndings(ft, above = above)
        all_endings[[as.character(dec)]][[as.character(i)]] <- getEndings(ft, above = 0)
        max_endings[[as.character(dec)]][[as.character(i)]] <- maxSuf(ft)
        
        # Declension & Num
        ft <- freqTable(df = sub_df, dec = dec, num = num)
        freq_tables[[paste0(dec, num)]][[as.character(i)]] <- ft
        endings[[paste0(dec, num)]][[as.character(i)]] <- getEndings(ft, above = above)
        all_endings[[paste0(dec, num)]][[as.character(i)]] <- getEndings(ft, above = 0)
        max_endings[[paste0(dec, num)]][[as.character(i)]] <- maxSuf(ft)
        
        # Declension, Num, & Case
        ft <- freqTable(df = sub_df, dec = dec, num = num, case = case)
        freq_tables[[paste0(dec, num, case)]][[as.character(i)]] <- ft
        if (dec == 5 & above >= 8) {
          endings[[paste0(dec, num, case)]][[as.character(i)]] <- getEndings(ft, above = 7)
        } else endings[[paste0(dec, num, case)]][[as.character(i)]] <- getEndings(ft, above = above)
        all_endings[[paste0(dec, num, case)]][[as.character(i)]] <- getEndings(ft, above = 0)
        max_endings[[paste0(dec, num, case)]][[as.character(i)]] <- maxSuf(ft)
        }
            
      for (gender in global_genders) {
        # Only Gender
        ft <- freqTable(df = sub_df, gender = gender)
        freq_tables[[gender]][[as.character(i)]] <- ft
        endings[[gender]][[as.character(i)]] <- getEndings(ft, above = above)
        all_endings[[gender]][[as.character(i)]] <- getEndings(ft, above = 0)
        max_endings[[gender]][[as.character(i)]] <- maxSuf(ft)
        
        # Gender & Num
        ft <- freqTable(df = sub_df, gender = gender, num = num)
        freq_tables[[paste0(gender, num)]][[as.character(i)]] <- ft
        endings[[paste0(gender, num)]][[as.character(i)]] <- getEndings(ft, above = above)
        all_endings[[paste0(gender, num)]][[as.character(i)]] <- getEndings(ft, above = 0)
        max_endings[[paste0(gender, num)]][[as.character(i)]] <- maxSuf(ft)
        
        # Gender, Num, & Case
        ft <- freqTable(df = sub_df, gender = gender, num = num, case = case)
        freq_tables[[paste0(gender, num, case)]][[as.character(i)]] <- ft
        endings[[paste0(gender, num, case)]][[as.character(i)]] <- getEndings(ft, above = above)
        all_endings[[paste0(gender, num, case)]][[as.character(i)]] <- getEndings(ft, above = 0)
        max_endings[[paste0(gender, num, case)]][[as.character(i)]] <- maxSuf(ft)
  
        # Create vector to be added to data frame of representative endings
        to_add <- paste0(gender, num, case)
        
        # All 4
        for (dec in global_decs) {
          if (dec %in% c(1, 5) & gender == 'n') {
            to_add <- c(to_add, NA)
            systems[[as.character(i)]][[paste0(gender, dec, num, case)]] <- NA
            next
          }
          ft <- freqTable(df = sub_df, gender = gender, dec = dec, num = num, case = case)
          freq_tables[[paste0(gender, dec, num, case)]][[as.character(i)]] <- ft
          if (dec == 5 & above >= 8) {
            endings[[paste0(gender, dec, num, case)]][[as.character(i)]] <- getEndings(ft, above = 7)
          } else endings[[paste0(gender, dec, num, case)]][[as.character(i)]] <- getEndings(ft, above = above)
          all_endings[[paste0(gender, dec, num, case)]][[as.character(i)]] <- getEndings(ft, above = 0)
          max_endings[[paste0(gender, dec, num, case)]][[as.character(i)]] <- maxSuf(ft)  
          
          # Use max endings to determine a "language system"
          if (onlymax == TRUE) { to_add <- c(to_add, maxSuf(ft))
          } else to_add <- c(to_add, getEndings(ft, above = above))
          # Also show systems as vectors to compare
          if (onlymax == TRUE) { systems[[as.character(i)]][[paste0(gender, dec, num, case)]] <- maxSuf(ft)
          } else systems[[as.character(i)]][[paste0(gender, dec, num, case)]] <- getEndings(ft, above = above)
          
        }
        
        # Now add endings  
        systems_df[[as.character(i)]] <- rbindlist(list(systems_df[[as.character(i)]], as.list(to_add)))
        
      }
    }
  }
}

# Now get frequency counts of ending systems
ending_distrib <- lapply(endings, count)
maxending_distrib <- lapply(max_endings, count)

# Get true systems and assign
if (code == 7) {
  to_read <- "../../../Analysis/True_Endings.txt"
} else if (code == 9) to_read <- "../../../../Analysis/True_Endings.txt"

true_systems_df <- read.delim(to_read, stringsAsFactors = FALSE)

true_systems <- list(common_system = structure(true_systems_df$ComSuf, names = true_systems_df$Combo),
                     NPLtoFSG_system = structure(true_systems_df$NPLFSGSuf, names = true_systems_df$Combo),
                     romanian_system = structure(true_systems_df$RomSuf, names = true_systems_df$Combo))

# Now check equality among systems and sum up percentage in which they match
# Function to take in true system an compare list of systems to it, creating percentile distribution
systemMatch <- function(systems, true_system) {
  system_match <- c()
  for (system in systems) {
    system <- system[names(true_system)]
    # Vector of truth values to show if same or not
    compare <- c()
    for (combo in names(system)) {
      suffixes <- unlist(strsplit(system[combo], ','))
      compare <- c(compare, any(suffixes %in% unlist(strsplit(true_system[combo], ','))))
    }
    nmatch <- sum(compare[!is.na(compare)])
    percent_match <- nmatch/length(!is.na(system))*100
    system_match <- c(system_match, percent_match)
  }
  system_distrib <- count(system_match)
  colnames(system_distrib)[1] <- "Percent_Match"
  system_distrib[["Percent_Trials"]] <- system_distrib$freq/sum(system_distrib$freq)*100
  return(system_distrib)
}

system_distribs <- list()

for (system_name in names(true_systems)) {
  system_distribs[[paste0(system_name, "distrib", sep = "_")]] <- systemMatch(systems, true_systems[[system_name]])
}

# Now we want to see specific trends, which match up with reality?
# First by declension
for (dec in global_decs) {
  true_dec_systems <- lapply(true_systems, function(x) x[grep(dec, names(x))])
  for (system_name in names(true_dec_systems)) {
    system_distribs[[paste0(dec, system_name, "distrib", sep = "_")]] <- systemMatch(systems, true_dec_systems[[system_name]])
  }
}
# Then gender
for (gender in global_genders) {
  true_gen_systems <- lapply(true_systems, function(x) x[grep(paste0(gender, '[[:digit:]]'), names(x))])
  for (system_name in names(true_gen_systems)) {
    system_distribs[[paste0(gender, system_name, "distrib", sep = "_")]] <- systemMatch(systems, true_gen_systems[[system_name]])
  }
}
# Then case
for (case in global_cases) {
  true_case_systems <- lapply(true_systems, function(x) x[grep(case, names(x))])
  for (system_name in names(true_case_systems)) {
    system_distribs[[paste0(case, system_name, "distrib", sep = "_")]] <- systemMatch(systems, true_case_systems[[system_name]])
  }
}
# Then number
for (num in global_nums) {
  true_num_systems <- lapply(true_systems, function(x) x[grep(num, names(x))])
  for (system_name in names(true_num_systems)) {
    system_distribs[[paste0(num, system_name, "distrib", sep = "_")]] <- systemMatch(systems, true_num_systems[[system_name]])
  }
}

print(system_distribs)

##
# Now make statements about which forms end up same
##

# Create function to check equality of combinations
# Take in system and vector of combinations to compare
# Return percentage that is same
checkSame <- function(system, to_search) {
  to_compare <- list()
  for (combo in to_search) {
    to_compare[[combo]] <- system[grep(combo, names(system))]
  }
  equal_vector <- is.equal(to_compare)[!is.na(is.equal(to_compare))]
  return(sum(equal_vector)/length(equal_vector)*100)
}

to_compare <- c("Nom,Acc", "Acc,Abl", "Nom,Acc,Abl", "Gen,Dat",
                "n.Sg,m.Sg", "n.Pl,m.Pl", "n.Pl,f.Sg", "n.Pl,f.Pl",
                "m.Pl,f.Pl", "1,5", "2,4")

comparisons <- list()

# How often do the nominative and accusative line up?
for (comparison in to_compare) {
  # Vector of percentage same to create distribution
  percent_same <- c()
  to_search <- unlist(strsplit(comparison, ','))
  for (system in systems) {
    percent_same <- c(percent_same, checkSame(system, to_search))
  }
  compare_distrib <- count(percent_same)
  colnames(compare_distrib)[1] <- "Percent_Match"
  compare_distrib[["Percent_Trials"]] <- compare_distrib$freq/sum(compare_distrib$freq)*100
  comparisons[[comparison]] <- compare_distrib
}

# For nPl and fPl and nPl and mPl, check LACK of sameness with other gender
nPlmPl_percentsame <- c()
nPlfPl_percentsame <- c()
for (system in systems) {
  # nPl and mPl but NOT fPl
  nPlmPl_samevector <- system[grep('n.Pl', names(system))] == system[grep('m.Pl', names(system))] & system[grep('n.Pl', names(system))] != system[grep('f.Pl', names(system))]
  # nPl and fPl but NOT mPl
  nPlfPl_samevector <- system[grep('n.Pl', names(system))] == system[grep('f.Pl', names(system))] & system[grep('n.Pl', names(system))] != system[grep('m.Pl', names(system))]
  
  # Now get percentages
  for (combo in c("nPlmPl", "nPlfPl")) {
    assign(paste0(combo, "_samevector"), eval(parse(text = paste0(combo, "_samevector")))[!is.na(eval(parse(text = paste0(combo, "_samevector"))))])
    assign(paste0(combo, "_percentsame"), c(eval(parse(text = paste0(combo, "_percentsame"))), sum(eval(parse(text = paste0(combo, "_samevector"))))/length(eval(parse(text = paste0(combo, "_samevector"))))*100))
  }
}

for (combo in c("nPlmPl_percentsame", "nPlfPl_percentsame")) {
  combo_same <- eval(parse(text = combo))
  compare_distrib <- count(combo_same)
  colnames(compare_distrib)[1] <- "Percent_Match"
  compare_distrib[["Percent_Trials"]] <- compare_distrib$freq/sum(compare_distrib$freq)*100
  comparisons[[gsub("_.*", "_exclusive", combo)]] <- compare_distrib
}

print(comparisons)

# Now we want to observe how many obey certain trends
trends <- c("Sg_nots", "Pl_s($|,)", "[mf].Pl_s($|,)", "n.Pl_s($|,)",
            "1Sg_a($|,)", "[24]Sg_o($|,)", "3Sg_[e-]($|,)", "3Pl_e?s",
            "[24]Pl_os($|,)", "1Pl_as($|,)", "n.Pl_a($|,)", "n.Pl_as($|,)", "n.Pl_os($|,)", "m.Pl_as($|,)",
            "1Sg(Nom|Acc)_a($|,)", "[24]Sg(Nom|Acc)_o($|,)", "3Sg(Nom|Acc)_[e-]($|,)", "3Pl(Nom|Acc)_e?s($|,)",
            "[24]Pl(Nom|Acc)_os($|,)", "1Pl(Nom|Acc)_as($|,)", "n.Pl(Nom|Acc)_a($|,)", "n.Pl(Nom|Acc)_as($|,)", "n.Pl(Nom|Acc)_os($|,)",
            "1Sg(Nom|Acc|Abl)_a($|,)", "[24]Sg(Nom|Acc|Abl)_o($|,)", "3Sg(Nom|Acc|Abl)_[e-]($|,)", "3Pl(Nom|Acc|Abl)_e?s($|,)",
            "[24]Pl(Nom|Acc|Abl)_os($|,)", "1Pl(Nom|Acc|Abl)_as($|,)", "n.Pl(Nom|Acc|Abl)_a($|,)", "n.Pl(Nom|Acc|Abl)_as($|,)", "n.Pl(Nom|Acc|Abl)_os($|,)", "m.Pl(Nom|Acc|Abl)_as($|,)",
            "1Sg(Gen|Dat)_e($|,)",
            "Pl(Nom|Acc)_s($|,)", "Pl(Nom|Acc|Abl)_s($|,)", "Pl(Gen|Dat)_s($|,)",
            "[124]Pl_s($|,)", "[124]Pl(Nom|Acc)_s($|,)", 
            "[124]Pl(Nom|Acc|Abl)_s($|,)", "[124]Pl(Gen|Dat)_s($|,)")

trend_distribs <- list()

for (trend in trends) {
  filter <- unlist(strsplit(trend, "_"))[1]
  ending <- unlist(strsplit(trend, "_"))[2]
  
  trend_success <- c()
  for (system in systems) {
    sub_sys <- system[grepl(filter, names(system))]
    sub_sys <- sub_sys[!is.na(sub_sys)]
    if (ending == "nots") { trend_success <- c(trend_success, sum(!grepl("s($|,)", sub_sys))/length(sub_sys)*100)
    } else trend_success <- c(trend_success, sum(grepl(ending, sub_sys))/length(sub_sys)*100)
    if (trend == "n.Pl(Nom|Acc)_as($|,)" & round(sum(grepl(ending, sub_sys))/length(sub_sys)*100, digits = 5) == 66.66667) print(sub_sys)
  }
  trend_distrib <- count(trend_success)
  colnames(trend_distrib)[1] <- "Percent_Match"
  trend_distrib[["Percent_Trials"]] <-     trend_distrib$freq/sum(compare_distrib$freq)*100
  trend_distribs[[trend]] <- trend_distrib
}

print(trend_distribs)
```
