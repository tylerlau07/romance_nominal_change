---
title: "NoSoundChange"
author: "Tyler Lau"
header-includes:
  - \DeclareUnicodeCharacter{0101}{\=a}
  - \DeclareUnicodeCharacter{012B}{\=\i}
  - \DeclareUnicodeCharacter{0113}{\=e}
  - \DeclareUnicodeCharacter{014D}{\=o}
  - \DeclareUnicodeCharacter{016B}{\=u}
date: "July 18, 2016"
output: pdf_document
---

```{r echo = FALSE, comment = NA}
library(stringr)

name <- "TokFreqT"

# setwd(paste0('../Main Code 9/Common', name))
setwd(paste0('../Main Code 7/', name))

print(paste0('No Sound Change, ', name))

files = list.files(pattern = '\\.txt')

global_genders <- c('m', 'f', 'n')
global_declensions <- 1:5
global_cases <- c('Nom', 'Acc', 'Gen', 'Dat', 'Abl')
global_nums <- c('Sg', 'Pl')

# IF APPLY SOUND CHANGE
soundchange <- TRUE
language <- 'common'

# Initialize variables to count proportion of trials in which relevant mergers happen
nomaccsg <- 0
accablsg <- 0
nomaccablsg <- 0

nomaccpl <- 0
accablpl <- 0
nomaccablpl <- 0

gendatsg <- 0
gendatpl <- 0

sg <- 0
pl <- 0

sg_same <- 0
pl_same <- 0

all_same <- 0

# Trends
pl_all_s <- 0    # All plurals end in -s
pl_nomacc_s <- 0 # Nom and Acc plurals end in -s
pl_all_mf_s <- 0 # All plurals (excluding neuter) end in -s
pl_nomacc_mf_s <- 0 # Nom and Acc plurals (excluding neuter) end in -s

#############
# Functions #
#############

# Remove rows with all 0's from frequency table
# Take in df with suffixes
remove_zeros <- function(input_table) return(input_table[apply(input_table, 1, function(x) !all(x < 5)), ])

applySoundChange <- function(vector, language) {
  # Dictionaries of changes
  diph_changes <- c('e', 'e', 'e', 'e', 'e', 'o')
  names(diph_changes) <- c('ai', 'ae', 'ei', 'ie', 'oe', 'au')
  
  sv_changes <- c('e', 'o', '')
  names(sv_changes) <- c('i', 'u', 'm')
  
  lv_changes <- c('a', 'e', 'i', 'o', 'u')
  names(lv_changes) <- c('ā', 'ē', 'ī', 'ō', 'ū')
  
  if (language == 'common') {
    for (diph in names(diph_changes)) new_sufs <- sub(diph, diph_changes[diph], vector)
    for (sv in names(sv_changes)) new_sufs <- sub(sv, sv_changes[sv], vector)
    for (lv in names(lv_changes)) new_sufs <- sub(lv, lv_changes[lv], vector)
  }
  
  return(new_sufs)
}

# Show frequency count table by number and case
freq_table <- function(input_table, trial) {
  tables <- list()
  print(paste('Trial', trial))
    for (num in global_nums) {
      for (case in global_cases) {
        
        freq_table <- data.frame(table(input_table)[ , , case, num])

        # Now show the whole table
        tables[[paste0(case, num)]] <- remove_zeros(freq_table)
      }
    }
  return(tables)
}

# Check if plurals end in s
# Need to give cases as a vector
getPlSuf <- function(df, cases, genders) {
  
  # Isolate necessary cases
  casegender_df <- df[df$Case %in% cases & df$Gender %in% genders, ]
  pl_table <- table(casegender_df)[ , , , 'Pl']

  # Isolate suffixes that are only used in the plural  
  all_suf <- c()
  for (case in cases) {
    current_suf <- remove_zeros(data.frame(pl_table[ , , case ]))
    
    all_suf <- c(all_suf, rownames(current_suf))
  }
  
  pl_suf <- unique(all_suf)
  return(pl_suf)
}
table(sub_d)[ , , "f", "Nom", "Sg"]
# Check endings for specific declension, case, number combo
decEndings <- function(df, decs, genders, cases, nums) {
  all_suf <- c()
  
  if (missing(genders)) {
    for (dec in decs) {
      for (case in cases) {
        for (num in nums) {
          current_suf <- remove_zeros(data.frame(table(df)[ , dec, , case, num]))
          
          all_suf <- c(all_suf, rownames(current_suf))
        }
      }
    }
  }
  
  else if (missing(decs)) {
    for (gen in genders) {
      for (case in cases) {
        for (num in nums) {
          current_suf <- remove_zeros(data.frame(table(df)[ , , gen, case, num]))
          
          all_suf <- c(all_suf, rownames(current_suf))
        }
      }
    }
  }
  
  all_suf <- unique(all_suf)
  return(all_suf)
}

# This function gets endings of a particular combination
# Take in specific combination and also the threshold for inclusion is (count above which must exist)
getEndings <- function(df, gender, dec, case, num, above) {
  sub_df <- subset(df, select = c("Suffix", "Gender", "Declension", "Case", "Num"))
  all_endings <- table(sub_df)[ , gender, dec, case, num]
  return(names(all_endings[all_endings > above]))
}

# Check if certain combinations end up the same
# Take in vector of cases/numbers/genders and determine if combo is same or not
# Returns truth value
checkSame <- function(df, gen1, num1, case1, gen2, num2, case2) {
  if (missing(gen1)) return(setequal(rownames(remove_zeros(data.frame(table(gencaseendings)[, , case1, num1]))), rownames(remove_zeros(data.frame(table(gencaseendings)[, , case2, num2]))))) 
  else return(setequal(rownames(remove_zeros(data.frame(table(gencaseendings)[, gen1, case1, num1]))) == rownames(remove_zeros(data.frame(table(gencaseendings)[, gen2, case2, num2])))))
}

########
# MAIN #
########

nomaccpl_suf_systems <- c()
nomaccpl_mf_suf_systems <- c()

# To collect endings
for (num in global_nums) {
  assign(paste(num, systems, sep = "_"), c())
  for (dec in c('I', 'II', 'III', 'IV', 'V')) {
    assign(paste(dec, num, systems, sep = "_"), c())
    assign(paste(dec, num, "nomacc", systems, sep = "_"), c())
  }
  for (gender in global_genders) {
    assign(paste(gender, num, systems, sep = "_"), c())
    assign(paste(gender, num, "nomacc", systems, sep = "_"), c())
  }
}

for (i in 1:length(files)) {
  file = files[i]
  
  nomaccsg_same <- FALSE
  accablsg_same <- FALSE
  nomaccablsg_same <- FALSE
  
  nomaccpl_same <- FALSE
  accablpl_same <- FALSE
  nomaccablpl_same <- FALSE
  
  gendatsg_same <- FALSE
  gendatpl_same <- FALSE

  # Count human as same as nonhuman
  df <- read.delim(file, stringsAsFactors = FALSE)

  # Modify endings files
  colnames(df)[which(names(df) == "X10")] <- "Suffix"
  
  df[df == 'mh'] <- 'm'
  df[df == 'fh'] <- 'f'
  df[df == 'mh, fh'] <- 'm'
  df[df == 'm, f'] <- 'm'
  
  if (soundchange == TRUE) df$Suffix <- applySoundChange(df$Suffix, language)
  
  df[df == ''] <- '-'
  
  # Modify gencaseendings files
  gencaseendings <- subset(df, select = c('X10', 'Gender', 'Case', 'Num'))
  names(gencaseendings)[1] <- 'Suffix'
  
  gencaseendings[gencaseendings == 'mh'] <- 'm'
  gencaseendings[gencaseendings == 'fh'] <- 'f'
  gencaseendings[gencaseendings == 'mh, fh'] <- 'm'
  gencaseendings[gencaseendings == 'm, f'] <- 'm'
  
  if (soundchange == TRUE) gencaseendings <- applySoundChange(gencaseendings, language)
  
  gencaseendings[gencaseendings == ''] <- '-'

  print(freq_table(gencaseendings, i))
  
  # Collect all systems
  # Modify above variable as necessary
  for (gender in global_genders) {
    for (dec in global_declensions) {
      for (case in global_cases) {
        for (num in global_nums) {
          assign(paste0(gender, dec, case, num, "_endings"), getEndings(df, gender, dec, case, num, 0))
        }
      }
    }
  }
  
  # Collect plural suffix systems
  nomaccpl_suf_systems <- c(nomaccpl_suf_systems, paste(sort(getPlSuf(gencaseendings, c("Nom", "Acc"), global_genders)), collapse = ", "))
  
  nomaccpl_mf_suf_systems <- c(nomaccpl_mf_suf_systems, paste(sort(getPlSuf(gencaseendings, c("Nom", "Acc"), c("m", "f"))), collapse = ", "))
  
  # Collect declension systems
  for (num in global_nums) {
    assign(paste(num, systems, sep = "_"), c(eval(parse(text = paste(num, systems, sep = "_"))), paste(sort(decEndings(endings, decs = )))))
    for (dec in c('I', 'II', 'III', 'IV', 'V')) {
      assign(paste(dec, num, systems, sep = "_"), c())
      assign(paste(dec, num, "nomacc", systems, sep = "_"), c())
    }
    for (gender in global_genders) {
      assign(paste(gender, num, systems, sep = "_"), c())
      assign(paste(gender, num, "nomacc", systems, sep = "_"), c())
    }
  }

  I_sg_systems <- c(I_sg_systems, paste(sort(decEndings(endings, decs = 1, cases = global_cases, nums = "Sg")), collapse = ","))
  II_sg_systems <- c(II_sg_systems, paste(sort(decEndings(endings, decs = 2, cases = global_cases, nums = "Sg")), collapse = ","))
  III_sg_systems <- c(III_sg_systems, paste(sort(decEndings(endings, decs = 3, cases = global_cases, nums = "Sg")), collapse = ","))
  IV_sg_systems <- c(IV_sg_systems, paste(sort(decEndings(endings, decs = 4, cases = global_cases, nums = "Sg")), collapse = ","))
  V_sg_systems <- c(V_sg_systems, paste(sort(decEndings(endings, decs = 5, cases = global_cases, nums = "Sg")), collapse = ","))

  I_pl_systems <- c(I_pl_systems, paste(sort(decEndings(endings, decs = 1, cases = global_cases, nums = "Pl")), collapse = ","))
  II_pl_systems <- c(II_pl_systems, paste(sort(decEndings(endings, decs = 2, cases = global_cases, nums = "Pl")), collapse = ","))
  III_pl_systems <- c(III_pl_systems, paste(sort(decEndings(endings, decs = 3, cases = global_cases, nums = "Pl")), collapse = ","))
  IV_pl_systems <- c(IV_pl_systems, paste(sort(decEndings(endings, decs = 4, cases = global_cases, nums = "Pl")), collapse = ","))
  V_pl_systems <- c(V_pl_systems, paste(sort(decEndings(endings, decs = 5, cases = global_cases, nums = "Pl")), collapse = ","))
  
  N_pl_systems <- c(N_pl_systems, paste(sort(decEndings(endings, genders = "n", cases = global_cases, nums = "Pl")), collapse = ","))
  
  I_sg_systems <- c(I_sg_systems, paste(sort(decEndings(endings, decs = 1, cases = global_cases, nums = "Sg")), collapse = ","))
  II_sg_systems <- c(II_sg_systems, paste(sort(decEndings(endings, decs = 2, cases = global_cases, nums = "Sg")), collapse = ","))
  III_sg_systems <- c(III_sg_systems, paste(sort(decEndings(endings, decs = 3, cases = global_cases, nums = "Sg")), collapse = ","))
  IV_sg_systems <- c(IV_sg_systems, paste(sort(decEndings(endings, decs = 4, cases = global_cases, nums = "Sg")), collapse = ","))
  V_sg_systems <- c(V_sg_systems, paste(sort(decEndings(endings, decs = 5, cases = global_cases, nums = "Sg")), collapse = ","))

  I_pl_systems <- c(I_pl_systems, paste(sort(decEndings(endings, decs = 1, cases = global_cases, nums = "Pl")), collapse = ","))
  II_pl_systems <- c(II_pl_systems, paste(sort(decEndings(endings, decs = 2, cases = global_cases, nums = "Pl")), collapse = ","))
  III_pl_systems <- c(III_pl_systems, paste(sort(decEndings(endings, decs = 3, cases = global_cases, nums = "Pl")), collapse = ","))
  IV_pl_systems <- c(IV_pl_systems, paste(sort(decEndings(endings, decs = 4, cases = global_cases, nums = "Pl")), collapse = ","))
  V_pl_systems <- c(V_pl_systems, paste(sort(decEndings(endings, decs = 5, cases = global_cases, nums = "Pl")), collapse = ","))
  
  N_pl_systems <- c(N_pl_systems, paste(sort(decEndings(endings, genders = "n", cases = global_cases, nums = "Pl")), collapse = ","))
  
  # Now let's see how well the results approximate Romance
  # First, which plurals end in "s"
  allpl_suf <- getPlSuf(gencaseendings, global_cases, global_genders)
  if (all(str_sub(allpl_suf, -1) == "s")) pl_all_s <- pl_all_s + 1
  
  nomaccpl_suf <- getPlSuf(gencaseendings, c('Nom', 'Acc'), global_genders)
  if (all(str_sub(nomaccpl_suf, -1) == "s")) pl_nomacc_s <- pl_nomacc_s + 1
  
  allpl_mf_suf <- getPlSuf(gencaseendings, global_cases, c('m', 'f'))
  if (all(str_sub(allpl_mf_suf, -1) == "s")) pl_all_mf_s <- pl_all_mf_s + 1

  nomaccpl_mf_suf <- getPlSuf(gencaseendings, c('Nom', 'Acc'), c('m', 'f'))
  if (all(str_sub(nomaccpl_mf_suf, -1) == "s")) pl_nomacc_mf_s <- pl_nomacc_mf_s + 1
  
  # Check where mergers happen--nom, acc, abl ; gen, dat
  if (checkSame(gencaseendings, case1 = 'Nom', num1 = 'Sg', case2 = 'Acc', num2 = 'Sg')) {
    nomaccsg <- nomaccsg + 1
    nomaccsg_same <- TRUE
  }
  if (checkSame(gencaseendings, case1 = 'Acc', num1 = 'Sg', case2 = 'Abl', num2 = 'Sg')) {
    accablsg <- accablsg + 1
    accablsg_same <- TRUE
  }
  if (nomaccsg_same & accablsg_same) {
    nomaccablsg <- nomaccablsg + 1
    nomaccablsg_same <- TRUE
  }
  
  if (checkSame(gencaseendings, case1 = 'Nom', num1 = 'Pl', case2 = 'Acc', num2 = 'Pl')) {
    nomaccpl <- nomaccpl + 1
    nomaccpl_same <- TRUE
  }
  if (checkSame(gencaseendings, case1 = 'Acc', num1 = 'Pl', case2 = 'Abl', num2 = 'Pl')) {
    accablpl <- accablpl + 1
    accablpl_same <- TRUE
  }
  if (nomaccpl_same & accablpl_same) {
    nomaccablpl <- nomaccablpl + 1
    nomaccablpl_same <- TRUE
  }
  
  if (checkSame(gencaseendings, case1 = 'Gen', num1 = 'Sg', case2 = 'Dat', num2 = 'Sg')) {
    gendatsg <- gendatsg + 1
    gendatsg_same <- TRUE
  }
  if (checkSame(gencaseendings, case1 = 'Gen', num1 = 'Pl', case2 = 'Dat', num2 = 'Pl')) {
    gendatpl <- gendatpl + 1
    gendatpl_same <- TRUE
  }
  
  if (all(table(gencaseendings)[, , , 'Sg'])) {
    sg <- sg + 1
  }
  if (all(table(gencaseendings)[, , , 'Pl'])) {
    pl <- pl + 1
  }
  
  if (all(table(gencaseendings))) {
    all_same <- all_same + 1
  }
}

tot_trials <- length(files)

print(paste("Percentage of trials where all plurals end in /s/", pl_all_s/tot_trials*100, "%"))
print(paste("Percentage of trials where Nom and Acc plurals end in /s/", pl_nomacc_s/tot_trials*100, "%"))
print(paste("Percentage of trials where all masculine/feminine plurals end in /s/", pl_all_mf_s/tot_trials*100, "%"))
print(paste("Percentage of trials where masculine/feminine Nom and Acc plurals end in /s/", pl_nomacc_mf_s/tot_trials*100, "%"))

print(paste("Percentage of trials where Nom.Sg and Acc.Sg end up the same", nomaccsg/tot_trials*100, "%"))
print(paste("Percentage of trials where Abl.Sg and Acc.Sg end up the same", accablsg/tot_trials*100, "%"))
print(paste("Percentage of trials where Nom.Sg, Acc.Sg, and Abl.Sg end up the same", nomaccablsg/tot_trials*100, "%"))

print(paste("Percentage of trials where Nom.Pl and Acc.Pl end up the same", nomaccpl/tot_trials*100, "%"))
print(paste("Percentage of trials where Abl.Pl and Acc.Pl end up the same", accablpl/tot_trials*100, "%"))
print(paste("Percentage of trials where Nom.Pl, Acc.Pl, and Abl.Pl end up the same", nomaccablpl/tot_trials*100, "%"))

print(paste("Percentage of trials where Gen.Sg and Dat.Sg end up the same", gendatsg/tot_trials*100, "%"))
print(paste("Percentage of trials where Gen.Pl and Dat.Pl end up the same", gendatpl/tot_trials*100, "%"))

print(paste("Percentage of trials where all singulars end up the same", sg/tot_trials*100, "%"))
print(paste("Percentage of trials where all plurals end up the same", pl/tot_trials*100, "%"))

print(paste("Percentage of trials where all forms end up the same", all_same/tot_trials*100, "%"))

print("I.SG Systems")
print(prop.table(sort(table(I_sg_systems), decreasing = TRUE)))
print("II.SG Systems")
print(prop.table(sort(table(II_sg_systems), decreasing = TRUE)))
print("III.SG Systems")
print(prop.table(sort(table(III_sg_systems), decreasing = TRUE)))
print("IV.SG Systems")
print(prop.table(sort(table(IV_sg_systems), decreasing = TRUE)))
print("V.SG Systems")
print(prop.table(sort(table(V_sg_systems), decreasing = TRUE)))

print("I.PL Systems")
print(prop.table(sort(table(I_pl_systems), decreasing = TRUE)))
print("II.PL Systems")
print(prop.table(sort(table(II_pl_systems), decreasing = TRUE)))
print("III.PL Systems")
print(prop.table(sort(table(III_pl_systems), decreasing = TRUE)))
print("IV.PL Systems")
print(prop.table(sort(table(IV_pl_systems), decreasing = TRUE)))
print("V.PL Systems")
print(prop.table(sort(table(V_pl_systems), decreasing = TRUE)))

print("N.PL Systems")
print(prop.table(sort(table(N_pl_systems), decreasing = TRUE)))

# print(table(nomaccpl_suf_systems))
# print(table(nomaccpl_mf_suf_systems))

#####################################
# MISCELLANEOUS REWORKING FUNCTIONS #
#####################################

# IF NEED TO REWRITE
# for (number in seq(1, 1)) {
#   fileframe <- 'stats_NoSoundChange_Epochs3_Gens10_TokFreqF_Trial'
#   file <- paste0('../Main Code 7/TokenFreqOff/', fileframe, number, '.txt')
#   
#   df <- read.delim(file)
#   
#   df$CaseNum <- df$Case
#   df$Case <- substring(df$CaseNum, 1, 3)
#   df$Num <- substring(df$CaseNum, 5, 6)
#   
#   df <- df[ , c(seq(1,3), 18, 4, 19, seq(5, 17))]
#   colnames(df)[seq(9, 19)] <- seq(0, 10)
#   
#   write.table(df, sep = "\t", quote = FALSE, file = paste0(fileframe, number, '.txt'))
# }

# TO CHECK

# fileframe <- 'stats_NoSoundChange_Epochs3_Gens10_TokFreqT_Trial'
# file <- paste0('../Main Code 7/TokenFreqOn/', fileframe, '01', '.txt')
# 
# d <- read.delim(file, stringsAsFactors = FALSE)
# 
# sub_d <- subset(d, select = c('X10', 'Declension', 'Gender', 'Case', 'Num'))
# names(sub_d)[1] <- 'Suffix'
# 
# sub_d[sub_d == 'mh'] <- 'm'
# sub_d[sub_d == 'fh'] <- 'f'
# sub_d[sub_d == 'mh, fh'] <- 'm'
# sub_d[sub_d == 'm, f'] <- 'm'
# 
# if (soundchange == TRUE) sub_d <- applySoundChange(sub_d, language)

```