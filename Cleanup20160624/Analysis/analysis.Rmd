---
title: "NoSoundChange"
author: "Tyler Lau"
header-includes:
  - \DeclareUnicodeCharacter{0101}{\=a}
  - \DeclareUnicodeCharacter{012B}{\=\i}
  - \DeclareUnicodeCharacter{0113}{\=e}
  - \DeclareUnicodeCharacter{014D}{\=o}
  - \DeclareUnicodeCharacter{016B}{\=u}
date: "July 18, 2016"
output: pdf_document
---

```{r echo = FALSE, comment = NA}
library(stringr)

# setwd('../Main Code 9/CommonTokFreqT')
setwd('../Main Code 7/TokenFreqOn')
files = list.files(pattern = '\\.txt')

genders <- c('m', 'f', 'n')
declensions <- 1:5
cases <- c('Nom', 'Acc', 'Gen', 'Dat', 'Abl')
nums <- c('Sg', 'Pl')

# Create dictionaries for sound changes
soundchange <- TRUE

diph_changes <- c('e', 'e', 'e', 'e', 'o')
names(diph_changes) <- c('ai', 'ae', 'ie', 'oe', 'au')

sv_changes <- c('e', 'o', '')
names(sv_changes) <- c('i', 'u', 'm')

lv_changes <- c('a', 'e', 'i', 'o', 'u')
names(lv_changes) <- c('ā', 'ē', 'ī', 'ō', 'ū')

# freq_table <- table(gencaseendings)[ , 'm', 'Sg', 'Nom']
# freq_table[freq_table > 5]
# 
# freq_table[apply(freq_table, 1, function(x) !all(x==0)), ]

# remove_zeros(data.frame(table(endings)[ , '2', , 'Sg', 'Nom']))
# 
# remove_zeros(table(endings)[ , '2', , 'Sg', 'Nom'])

# Initialize variables to count proportion of trials in which relevant mergers happen
nomaccsg <- 0
accablsg <- 0
nomaccablsg <- 0

nomaccpl <- 0
accablpl <- 0
nomaccablpl <- 0

gendatsg <- 0
gendatpl <- 0

sg <- 0
pl <- 0

sg_same <- 0
pl_same <- 0

all_same <- 0

# Trends
pl_all_s <- 0    # All plurals end in -s
pl_nomacc_s <- 0 # Nom and Acc plurals end in -s
pl_all_mf_s <- 0 # All plurals (excluding neuter) end in -s
pl_nomacc_mf_s <- 0 # Nom and Acc plurals (excluding neuter) end in -s

#############
# Functions #
#############

# Remove rows with all 0's from frequency table
remove_zeros <- function(input_table) return(input_table[apply(input_table, 1, function(x) !all(x==0)), ])

# Show frequency count table by number and case
freq_table <- function(input_table, trial) {
  tables <- list()
  print(paste('Trial', trial))
    for (num in nums) {
      for (case in cases) {
        
        freq_table <- data.frame(table(input_table)[ , , num, case])

        # Now show the whole table
        tables[[paste0(case, num)]] <- remove_zeros(freq_table)
      }
    }
  return(tables)
}

# Check if plurals end in s
# Need to give cases as a vector
getPlSuf <- function(df, cases, genders) {
  
  # Isolate necessary cases
  casegender_df <- df[df$Case %in% cases & df$Gender %in% genders, ]
  pl_table <- data.frame(table(casegender_df)[ , , 'Pl', ])
  all_suffixes <- remove_zeros(pl_table)
  
  # Isolate suffixes that are only used in the plural
  pl_suffixes <- names(all_suffixes[all_suffixes == TRUE])
  return(pl_suffixes)
}

# Check if certain combinations end up the same
# Take in vector of cases/numbers/genders and determine if combo is same or not
# Returns truth value
checkSame <- function(df, gen1, num1, case1, gen2, num2, case2) {
  if (missing(gen1)) return(all(data.frame(table(gencaseendings)[, , num1, case1]) == data.frame(table(gencaseendings)[, , num2, case2]))) 
  else return(all(data.frame(table(gencaseendings)[, gen1, num1, case1]) == data.frame(table(gencaseendings)[, gen2, num2, case2])))
}


for (i in 1:length(files)) {
  file = files[i]
  
  nomaccsg_same <- FALSE
  accablsg_same <- FALSE
  nomaccablsg_same <- FALSE
  
  nomaccpl_same <- FALSE
  accablpl_same <- FALSE
  nomaccablpl_same <- FALSE
  
  gendatsg_same <- FALSE
  gendatpl_same <- FALSE

  # Count human as same as nonhuman
  
  df <- read.delim(file, stringsAsFactors = FALSE)

  df[df == 'mh'] <- 'm'
  df[df == 'fh'] <- 'f'
  df[df == 'mh, fh'] <- 'm'
  df[df == 'm, f'] <- 'm'
  
  # If apply sound change
  if (soundchange == TRUE) {
    for (diph in names(diph_changes)) df$X10 <- sub(diph, diph_changes[diph], df$X10)
    for (sv in names(sv_changes)) df$X10 <- sub(sv, sv_changes[sv], df$X10)
    for (lv in names(lv_changes)) df$X10 <- sub(lv, lv_changes[lv], df$X10)
  }
  
  df[df == ''] <- '-'
  
  endings <- subset(df, select = c('X10', 'Declension', 'Gender', 'Num', 'Case'))
  gencaseendings <- subset(df, select = c('X10', 'Gender', 'Num', 'Case'))
  
  print(freq_table(gencaseendings, i))
  
  # Now let's see how well the results approximate Romance
  # First, which plurals end in "s"
  allpl_suf <- getPlSuf(gencaseendings, cases, genders)
  if (all(str_sub(allpl_suf, -1) == "s")) pl_all_s <- pl_all_s + 1
  
  nomaccpl_suf <- getPlSuf(gencaseendings, c('Nom', 'Acc'), genders)
  if (all(str_sub(nomaccpl_suf, -1) == "s")) pl_nomacc_s <- pl_nomacc_s + 1
  
  allpl_mf_suf <- getPlSuf(gencaseendings, cases, c('m', 'f'))
  if (all(str_sub(allpl_mf_suf, -1) == "s")) pl_all_mf_s <- pl_all_mf_s + 1

  nomaccpl_mf_suf <- getPlSuf(gencaseendings, c('Nom', 'Acc'), c('m', 'f'))
  if (all(str_sub(nomaccpl_mf_suf, -1) == "s")) pl_nomacc_mf_s <- pl_nomacc_mf_s + 1
  
  # Check where mergers happen--nom, acc, abl ; gen, dat
  if (checkSame(gencaseendings, case1 = 'Nom', num1 = 'Sg', case2 = 'Acc', num2 = 'Sg')) {
    nomaccsg <- nomaccsg + 1
    nomaccsg_same <- TRUE
  }
  if (checkSame(gencaseendings, case1 = 'Acc', num1 = 'Sg', case2 = 'Abl', num2 = 'Sg')) {
    accablsg <- accablsg + 1
    accablsg_same <- TRUE
  }
  if (nomaccsg_same & accablsg_same) {
    nomaccablsg <- nomaccablsg + 1
    nomaccablsg_same <- TRUE
  }
  
  if (checkSame(gencaseendings, case1 = 'Nom', num1 = 'Pl', case2 = 'Acc', num2 = 'Pl')) {
    nomaccpl <- nomaccpl + 1
    nomaccpl_same <- TRUE
  }
  if (checkSame(gencaseendings, case1 = 'Acc', num1 = 'Pl', case2 = 'Abl', num2 = 'Pl')) {
    accablpl <- accablpl + 1
    accablpl_same <- TRUE
  }
  if (nomaccpl_same & accablpl_same) {
    nomaccablpl <- nomaccablpl + 1
    nomaccablpl_same <- TRUE
  }
  
  if (checkSame(gencaseendings, case1 = 'Gen', num1 = 'Sg', case2 = 'Dat', num2 = 'Sg')) {
    gendatsg <- gendatsg + 1
    gendatsg_same <- TRUE
  }
  if (checkSame(gencaseendings, case1 = 'Gen', num1 = 'Pl', case2 = 'Dat', num2 = 'Pl')) {
    gendatpl <- gendatpl + 1
    gendatpl_same <- TRUE
  }
  
  if (all(table(gencaseendings)[, , 'Sg', ])) {
    sg <- sg + 1
  }
  if (all(table(gencaseendings)[, , 'Pl', ])) {
    pl <- pl + 1
  }
  
  if (all(table(gencaseendings))) {
    all_same <- all_same + 1
  }
}

tot_trials <- length(files)

print(paste("Percentage of trials where all plurals end in /s/", pl_all_s/tot_trials))
print(paste("Percentage of trials where Nom and Acc plurals end in /s/", pl_nomacc_s/tot_trials))
print(paste("Percentage of trials where all plurals end in /s/", pl_all_mf_s/tot_trials))
print(paste("Percentage of trials where Nom and Acc plurals end in /s/", pl_nomacc_mf_s/tot_trials))

print(paste("Percentage of trials where Nom.Sg and Acc.Sg end up the same", nomaccsg/tot_trials))
print(paste("Percentage of trials where Abl.Sg and Acc.Sg end up the same", accablsg/tot_trials))
print(paste("Percentage of trials where Nom.Sg, Acc.Sg, and Abl.Sg end up the same", nomaccablsg/tot_trials))

print(paste("Percentage of trials where Nom.Pl and Acc.Pl end up the same", nomaccpl/tot_trials))
print(paste("Percentage of trials where Abl.Pl and Acc.Pl end up the same", accablpl/tot_trials))
print(paste("Percentage of trials where Nom.Pl, Acc.Pl, and Abl.Pl end up the same", nomaccablpl/tot_trials))

print(paste("Percentage of trials where Gen.Sg and Dat.Sg end up the same", gendatsg/tot_trials))
print(paste("Percentage of trials where Gen.Pl and Dat.Pl end up the same", gendatpl/tot_trials))

print(paste("Percentage of trials where all singulars end up the same", sg/tot_trials))
print(paste("Percentage of trials where all plurals end up the same", pl/tot_trials))

print(paste("Percentage of trials where all forms end up the same", all_same/tot_trials))

# df[df$Num == "Sg" & df$Case == "Nom" & df$X10 == "es", ]

# Now we want to count up the different systems that exist-disregarding those endings that are rare (let's say < 10). We can do this as a percentage, ex. 12% of systems have F Nom Sg as a, etc.
# 
# # Create array with gender/case/num combo as columns
# for (i in 1:length(files)) {
#   file = files[i]
#   df <- read.delim(file)
#   
#   
# }

# file <- '../Main Code 7/TokenFreqOn/stats_NoSoundChange_Epochs3_Gens10_TokFreqT_Trial1.txt'
# df <- read.delim(file, stringsAsFactors = FALSE)
# df[df == 'mh'] <- 'm'
# df[df == 'fh'] <- 'f'
# df[df == 'mh, fh'] <- 'm'
# df[df == 'm, f'] <- 'm'
# df[df == ''] <- '-'
# gencaseendings <- subset(df, select = c('X10', 'Gender', 'Num', 'Case'))
# current_table <- table(gencaseendings)[ , , 'Pl', ]
# # 
# gencaseendings[gencaseendings$Case %in% c("Nom", "Acc"), ]
# 
# nomacc_only <- table(gencaseendings[gencaseendings$Case %in% c("Nom", "Acc"), ])
# 
# nomacc_only[ , , "Pl", ]
# nomacc_suffixes <- apply(nomacc_only, 1, function(x) !all(x==0))
# nomaccpl_suffixes <- names(nomacc_suffixes[nomacc_suffixes == TRUE])
# names(nomacc_suffixes[nomacc_suffixes == TRUE])


# current_table
# 
# all_suffixes <- apply(current_table, 1, function(x) !all(x==0))
# 
# current_suffixes <- names(all_suffixes[all_suffixes == TRUE])
# 
# all(str_sub(current_suffixes, -1) == "s")
# 
# current_table[apply(current_table, 1, function(x) !all(x==0)), , ]
# 
# new_table <- current_table[apply(current_table, 1, function(x) !all(x==0)), ]
# 
# max(new_table[ , 'f'])

# IF NEED TO REWRITE
# for (number in seq(1, 10)) {
#   fileframe <- 'stats_NoSoundChange_Epochs3_Gens10_TokFreqT_Trial'
#   file <- paste0('../Main Code 7/TokenFreqOn/', fileframe, number, '.txt')
#   
#   df <- read.delim(file)
#   
# #   df$CaseNum <- df$Case
# #   df$Case <- substring(df$CaseNum, 1, 3)
# #   df$Num <- substring(df$CaseNum, 5, 6)
#   
# #   df <- df[ , c(seq(1,3), 18, 4, 19, seq(5, 17))]
#   colnames(df)[seq(9, 19)] <- seq(0, 10)
#   
#   write.table(df, sep = "\t", quote = FALSE, file = paste0(fileframe, number, '.txt'))
# }

```